<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wonderful-Wino Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Define CSS Variables for themes */
        :root {
            --bg-color: #f8f5ed;
            --text-color: #333;
            --header-color: #4a0e4e;
            --accent-color: #6b21a8;
            --card-bg: white;
            --border-color: #e5e7eb;
            --button-primary-bg: #8b5cf6; /* A purple tone for primary buttons */
            --button-primary-hover-bg: #7c3aed;
            --button-secondary-bg: #e5e7eb;
            --button-secondary-text: #4b5563;
            --button-secondary-hover-bg: #d1d5db;
            --table-header-bg: #f9fafb;
            --table-border-color: #e5e7eb;
            --input-bg: var(--card-bg); /* Input background defaults to card background */
            --input-text: var(--text-color); /* Input text defaults to main text color */
            --input-border: var(--border-color); /* Input border defaults to main border color */
        }

        /* Dark Theme Variables */
        .dark-theme {
            --bg-color: #2d3748; /* Dark background */
            --text-color: #e2e8f0; /* Light text */
            --header-color: #b794f4; /* Lighter purple for headers */
            --accent-color: #9f7aea; /* Another lighter purple for accents */
            --card-bg: #4a5568; /* Darker card background */
            --border-color: #6b7280;
            --button-primary-bg: #9f7aea;
            --button-primary-hover-bg: #b794f4;
            --button-secondary-bg: #6b7280;
            --button-secondary-text: #e2e8f0;
            --button-secondary-hover-bg: #718096;
            --table-header-bg: #4a5568;
            --table-border-color: #6b7280; /* Adjusted for better visibility in dark mode */
            --input-bg: #2d3748; /* Darker input background for contrast */
            --input-text: #e2e8f0; /* Light text for inputs */
            --input-border: #6b7280; /* Consistent border for inputs */
        }

        /* Custom styles to ensure Inter font is applied universally and for basic body reset */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: var(--bg-color); /* Use CSS variable */
            color: var(--text-color); /* Use CSS variable */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition */
        }
        /* Style for wine details in the table */
        .wine-details-cell h4 {
            font-weight: 600; /* Semi-bold for wine name */
            margin-bottom: 0.25rem;
            color: var(--header-color); /* Use CSS variable */
        }
        .wine-details-cell p {
            margin-top: 0.25rem;
            margin-bottom: 0.25rem;
            line-height: 1.3;
            color: var(--text-color); /* Use CSS variable */
        }
        .wine-details-cell strong {
            font-weight: 700; /* Bold for important text */
            color: var(--accent-color); /* Use CSS variable */
        }

        /* Apply theme variables to other elements */
        .bg-white {
            background-color: var(--card-bg) !important; /* Override Tailwind's bg-white */
            transition: background-color 0.3s ease;
        }
        .text-purple-800 {
            color: var(--header-color) !important;
        }
        .text-gray-800 {
            color: var(--text-color) !important;
        }
        .text-gray-700 {
            color: var(--text-color) !important;
        }
        .border-gray-300 {
            border-color: var(--border-color) !important;
        }
        .focus\:ring-purple-500:focus {
            --tw-ring-color: var(--accent-color) !important;
        }
        .bg-purple-600 {
            background-color: var(--button-primary-bg) !important;
        }
        .hover\:bg-purple-700:hover {
            background-color: var(--button-primary-hover-bg) !important;
        }
        .bg-gray-200 {
            background-color: var(--button-secondary-bg) !important;
        }
        .hover\:bg-gray-300:hover {
            background-color: var(--button-secondary-hover-bg) !important;
        }
        .text-gray-600 {
            color: var(--button-secondary-text) !important;
        }
        .bg-gray-50 {
            background-color: var(--table-header-bg) !important;
        }
        .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--table-border-color) !important;
        }
        /* Explicitly set border-gray-200 to use table-border-color */
        .border-gray-200 {
            border-color: var(--table-border-color) !important;
        }
        .text-gray-500 {
            color: var(--text-color) !important; /* Adjust for general text within tables/messages */
        }
        .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 500px;
            width: 90%;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            transition: background-color 0.3s ease, color 0.3s ease;
            padding: 1.5rem;
            border-radius: 0.5rem;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-close-button {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }
        .modal-close-button:hover {
            color: var(--accent-color);
        }
        /* Style for the sort icon */
        .sort-icon {
            display: inline-block;
            vertical-align: middle;
            fill: currentColor;
        }
        /* Specific adjustments for buttons that use fixed colors for semantic meaning (red/green/blue) */
        .bg-red-600 { background-color: #dc2626 !important; }
        .hover\:bg-red-700:hover { background-color: #b91c1c !important; }
        .bg-green-600 { background-color: #16a34a !important; }
        .hover\:bg-green-700:hover { background-color: #15803d !important; }
        .text-green-600 { color: #16a34a !important; }
        .hover\:text-green-900:hover { color: #14532d !important; }
        .text-red-600 { color: #dc2626 !important; }
        .hover\:text-red-900:hover { color: #7f1d1d !important; }
        .bg-blue-600 { background-color: #2563eb !important; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8 !important; }
        .text-blue-600 { color: #2563eb !important; }

        /* Styles for the theme toggle button */
        #themeToggle {
            background-color: var(--button-secondary-bg);
            color: var(--button-secondary-text);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 9999px; /* Pill shape */
            cursor: pointer;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        #themeToggle:hover {
            background-color: var(--button-secondary-hover-bg);
        }

        /* --- Fixes for Dark Mode Visibility --- */
        /* Apply theme colors to specific input and select elements */
        input[type="text"],
        input[type="number"],
        select {
            background-color: var(--input-bg) !important;
            color: var(--input-text) !important;
            border-color: var(--input-border) !important;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* Specific style for the sort direction toggle button */
        #sortDirectionToggle {
            background-color: var(--button-secondary-bg) !important;
            color: var(--button-secondary-text) !important;
            border-color: var(--border-color) !important; /* Ensure border also changes */
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        #sortDirectionToggle:hover {
            background-color: var(--button-secondary-hover-bg) !important;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8">

    <header class="text-center mb-8 px-4 w-full max-w-4xl flex justify-between items-center">
        <h1 class="text-4xl font-extrabold text-purple-800 tracking-tight">Wonderful Wino</h1>
        <button id="themeToggle" class="flex items-center space-x-2 px-3 py-2 rounded-full shadow-sm text-sm">
            <span id="themeIcon">☀️</span>
            <span id="themeText">Light Mode</span>
        </button>
    </header>

    <main class="w-full max-w-4xl px-4">
        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Add Wine to Inventory</h2>

            <div class="mb-6">
                <p class="text-gray-700 mb-2 font-medium">Add from Vivino</p>
                <p class="text-gray-700 mb-2 text-sm">First, search Vivino to find your wine's page. Remember to include the vintage!</p>
                <form id="vivinoSearchForm" class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="text" id="vivinoSearchInput" placeholder="e.g., 'Chateau Lafite 2010'"
                           class="flex-grow px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button type="submit"
                            class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        Search Vivino
                    </button>
                </form>

                <p class="text-gray-700 mb-2 text-sm">Once you find the wine on Vivino, paste its URL below to add it:</p>
                <form id="scanWineForm" class="flex flex-col sm:flex-row gap-4 items-center">
                    <input type="text" id="vivinoUrlInput" placeholder="Paste Vivino URL here"
                           class="flex-grow px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                    <div class="flex items-center gap-2 w-full sm:w-auto">
                        <label for="quantityInput" class="text-gray-700 font-medium whitespace-nowrap">Qty:</label>
                        <input type="number" id="quantityInput" placeholder="1" min="1" value="1"
                               class="w-20 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <button type="submit"
                            class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        Add from URL
                    </button>
                </form>
                <div id="scanMessage" class="mt-4 text-center hidden"></div>
            </div>

            <div class="mt-6 pt-6 border-t border-gray-200 text-center">
                <button id="openManualAddModalBtn" class="bg-gray-200 text-gray-600 font-semibold px-6 py-2 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">
                    Type in Yourself
                </button>
            </div>

        </section>

        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 sm:mb-4">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 sm:mb-0">Wine on-hand</h2>
                <div class="flex items-center gap-2">
                    <select id="sortSelect" class="px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm w-32">
                        <option value="name">Name</option>
                        <option value="varietal">Varietal</option>
                        <option value="country">Country</option>
                        <option value="region">Region</option>
                        <option value="vintage">Vintage</option>
                        <option value="rating">Rating</option>
                        <option value="quantity">Quantity</option>
                    </select>
                    <button id="sortDirectionToggle" class="px-2 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400" aria-label="Toggle sort direction">
                        <svg id="sortAscIcon" class="w-5 h-5 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"></path>
                        </svg>
                        <svg id="sortDescIcon" class="w-5 h-5 sort-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 20h13M3 16h9m-9-4h6m4 0l4 4m0 0l4-4m-4 4V4"></path>
                        </svg>
                    </button>
                </div>
            </div>


            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">
                                Image
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">
                                Wine Details
                            </th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="py-4 text-center text-gray-500">Loading inventory...</td></tr>
                    </tbody>
                </table>
            </div>
            <div id="inventoryMessage" class="mt-4 text-center hidden"></div>
        </section>

        <section class="mt-12 w-full max-w-xl p-6 bg-white rounded-lg shadow-md mx-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Maintenance</h2>

            <div class="flex flex-col sm:flex-row gap-4 mb-4 items-center">
                <button id="syncAllWinesButton"
                        class="w-full sm:flex-grow bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Sync ToDo from DB
                </button>
                <button id="reinitializeDbButton"
                        class="w-full sm:flex-grow bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 focus:outline-none focus:ring-4 focus:ring-red-300">
                    Reset DB
                </button>
                <button id="helpButton"
                        class="w-12 h-12 flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition duration-300 focus:outline-none focus:ring-4 focus:ring-green-300 flex-shrink-0">
                    ?
                </button>
            </div>
            <div id="reinitializeDbMessage" class="mt-3 text-center font-medium"></div>
            <div id="syncMessage" class="mt-3 text-center font-medium"></div>
        </section>

        <div id="root" class="w-full max-w-4xl px-4">
            </div>
    </main>

    <footer class="mt-8 text-center text-gray-500 text-sm px-4">
        <p>&copy; 2025 Wonderful-Wino. All rights reserved.</p>
    </footer>

    <div id="helpModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeHelpModal()">&times;</button>
            <h3 class="text-xl font-semibold mb-4">Maintenance Help</h3>
            <p class="text-sm">
                This section provides tools to manage your wine inventory database and its synchronization with Home Assistant.
            </p>
            <ul class="list-disc pl-5 mt-3 text-sm space-y-2">
                <li><strong>Sync Todo from DB:</strong> This button will synchronize your entire wine inventory from the Wonderful-Wino database to your Home Assistant To-Do list. It attempts to update or re-add every wine from your inventory into the list.</li>
                <li><strong>Reset DB:</strong> <span class="font-bold text-red-600">WARNING:</span> This action will permanently delete ALL your wine data from the Wonderful-Wino database. This cannot be undone. Use this only if you want to start your wine inventory from scratch.</li>
            </ul>
            <p class="text-sm mt-3">
                <span class="font-bold">Important Note:</span> If your To-Do list contains items that are no longer in your inventory, the "Sync" operation will not remove them. You may need to clear these manually in Home Assistant.
            </p>
            <div class="mt-6 text-right">
                <button onclick="closeHelpModal()" class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    Close
                </button>
            </div>
        </div>
    </div>

    <div id="manualAddModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeManualAddModal()">&times;</button>
            <h3 class="text-xl font-semibold mb-4">Add Wine Manually</h3>
            <form id="manualWineForm">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="sm:col-span-2">
                        <label for="manualNameInput" class="block text-sm font-medium">Wine Name *</label>
                        <input type="text" id="manualNameInput" placeholder="e.g., Chateau Montelena Chardonnay"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div>
                        <label for="manualVintageInput" class="block text-sm font-medium">Vintage *</label>
                        <input type="number" id="manualVintageInput" placeholder="e.g., 2019"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div>
                        <label for="manualVarietalInput" class="block text-sm font-medium">Varietal</label>
                        <input type="text" id="manualVarietalInput" placeholder="e.g., Chardonnay"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="manualRegionInput" class="block text-sm font-medium">Region</label>
                        <input type="text" id="manualRegionInput" placeholder="e.g., Napa Valley"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label for="manualQuantityInput" class="block text-sm font-medium">Quantity *</label>
                        <input type="number" id="manualQuantityInput" min="1" value="1"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                </div>
                <div id="manualAddMessage" class="mt-4 text-center hidden"></div>
                <div class="mt-6 flex justify-end gap-4">
                     <button type="button" onclick="closeManualAddModal()"
                            class="bg-gray-200 text-gray-600 px-6 py-2 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">
                        Cancel
                    </button>
                    <button type="submit"
                            class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        Add Wine
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // Define BASE_URL for API calls, using __ingress_url if available
        let BASE_URL = '';
        if (typeof window !== 'undefined' && typeof window.__ingress_url !== 'undefined' && window.__ingress_url !== '') {
            BASE_URL = window.__ingress_url;
        } else {
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length > 0 && pathParts[pathParts.length - 1].includes('.')) {
                pathParts.pop();
            }
            BASE_URL = pathParts.join('/');
            if (BASE_URL !== '' && !BASE_URL.endsWith('/')) {
                BASE_URL += '/';
            }
        }
        console.log('Calculated BASE_URL:', BASE_URL);

        // Global variable to store the raw inventory data
        let currentInventory = [];
        let currentSortBy = 'name';
        let currentSortDirection = 'asc';

        // --- Utility Functions for Messaging ---
        function showMessage(elementId, message, type = 'info', isModal = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `mt-4 text-center p-2 rounded-md ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            element.style.display = 'block';

            if (!isModal) {
                 setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // --- Sorting Logic ---
        function sortInventory(inventory, sortBy, sortDirection) {
            const sortedInventory = [...inventory];

            sortedInventory.sort((a, b) => {
                let comparison = 0;
                const getValue = (item, prop) => {
                    let value = item[prop];
                    if (value == null) {
                        if (prop === 'vintage' || prop === 'rating' || prop === 'quantity') {
                            return sortDirection === 'asc' ? Infinity : -Infinity;
                        }
                        return '';
                    }
                    return typeof value === 'string' ? value.toLowerCase() : value;
                };

                const valA = getValue(a, sortBy);
                const valB = getValue(b, sortBy);

                if (valA < valB) comparison = -1;
                if (valA > valB) comparison = 1;

                if (comparison === 0) {
                    const nameA = getValue(a, 'name');
                    const nameB = getValue(b, 'name');
                    if (nameA < nameB) comparison = -1;
                    if (nameA > nameB) comparison = 1;

                    if (comparison === 0) {
                        const vintageA = getValue(a, 'vintage');
                        const vintageB = getValue(b, 'vintage');
                        comparison = vintageA - vintageB;
                    }
                }

                return sortDirection === 'desc' ? -comparison : comparison;
            });

            return sortedInventory;
        }

        function applySortAndDisplayInventory() {
            const sortedData = sortInventory(currentInventory, currentSortBy, currentSortDirection);
            displayInventory(sortedData);
        }

        // --- Fetch Inventory ---
        async function fetchInventory() {
            const inventoryTableBody = document.getElementById('inventoryTableBody');
            try {
                inventoryTableBody.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-gray-500">Loading inventory...</td></tr>';
                const url = `${BASE_URL}inventory`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                currentInventory = await response.json();
                applySortAndDisplayInventory();
            } catch (error) {
                console.error('Error fetching inventory:', error);
                showMessage('inventoryMessage', `Failed to load inventory: ${error.message}`, 'error');
                inventoryTableBody.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-gray-500">Error loading inventory.</td></tr>';
            }
        }

        // --- Display Inventory ---
        function displayInventory(inventory) {
            const container = document.getElementById('inventoryTableBody');
            container.innerHTML = '';

            if (inventory.length === 0) {
                container.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-gray-500">No wines in your inventory yet!</td></tr>';
                return;
            }

            inventory.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 flex flex-col sm:table-row';

                const imageCell = document.createElement('td');
                imageCell.className = 'py-4 sm:p-4 flex justify-center sm:block';
                imageCell.innerHTML = item.image_url
                    ? `<img src="${item.image_url}" class="h-24 w-24 object-cover rounded-md" alt="Wine Image">`
                    : '<div class="text-gray-400 text-center w-24 h-24 flex items-center justify-center bg-gray-100 rounded-md">No Image</div>';

                const detailsCell = document.createElement('td');
                detailsCell.className = 'py-4 sm:p-4 text-sm text-gray-900 wine-details-cell w-full sm:w-auto text-center sm:text-left';
                let detailsHtml = `<h4>${item.name || 'N/A'} ${item.vintage ? `(${item.vintage})` : ''}</h4>`;
                if (item.varietal && item.varietal !== "Unknown Varietal") {
                    detailsHtml += `<p><strong>Varietal:</strong> ${item.varietal}</p>`;
                }
                let location = [];
                if (item.region && item.region !== "Unknown Region") location.push(item.region);
                if (item.country && item.country !== "Unknown Country") location.push(item.country);
                if (location.length > 0) {
                    detailsHtml += `<p><strong>Origin:</strong> ${location.join(', ')}</p>`;
                }
                if (item.vivino_rating) {
                    detailsHtml += `<p><strong>Rating:</strong> ${item.vivino_rating.toFixed(1)} ⭐${item.vivino_num_ratings ? ` (${item.vivino_num_ratings} ratings)` : ''}</p>`;
                }
                detailsCell.innerHTML = detailsHtml;

                const actionsCell = document.createElement('td');
                actionsCell.className = 'py-4 sm:p-4 flex flex-row justify-center items-center gap-2 w-full sm:w-auto';

                const consumeBtn = document.createElement('button');
                consumeBtn.innerHTML = '🍷';
                consumeBtn.title = 'Consume 1 Bottle';
                consumeBtn.className = 'text-green-600 hover:text-green-900 text-xl';
                consumeBtn.onclick = () => consumeWine(item.vivino_url);

                const qtyInput = document.createElement('input');
                qtyInput.type = 'number';
                qtyInput.value = item.quantity;
                qtyInput.min = 0;
                qtyInput.className = 'w-16 text-center border border-gray-300 rounded-md px-2 py-1';
                qtyInput.title = 'Edit Quantity';
                qtyInput.onblur = () => setWineQuantity(item.vivino_url, qtyInput.value);
                qtyInput.onkeydown = (e) => {
                    if (e.key === 'Enter') qtyInput.blur();
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '🗑️';
                deleteBtn.title = 'Delete Wine from Inventory';
                deleteBtn.className = 'text-red-600 hover:text-red-900 text-xl';
                deleteBtn.onclick = () => deleteWine(item.vivino_url);

                actionsCell.appendChild(consumeBtn);
                actionsCell.appendChild(qtyInput);
                actionsCell.appendChild(deleteBtn);

                row.appendChild(imageCell);
                row.appendChild(detailsCell);
                actionsCell.classList.add('flex', 'justify-center', 'items-center', 'sm:justify-start');
                row.appendChild(actionsCell);

                container.appendChild(row);
            });
        }

        // --- Scan Wine ---
        document.getElementById('scanWineForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const vivinoUrl = document.getElementById('vivinoUrlInput').value;
            const quantity = document.getElementById('quantityInput').value;
            try {
                const response = await fetch(`${BASE_URL}scan-wine`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vivino_url: vivinoUrl, quantity: parseInt(quantity, 10) || 1 })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Failed to scan wine');
                showMessage('scanMessage', result.message || 'Wine scanned successfully!');
                document.getElementById('scanWineForm').reset();
                fetchInventory();
            } catch (error) {
                showMessage('scanMessage', `Error: ${error.message}`, 'error');
            }
        });
        
        // --- Manual Add Wine ---
        document.getElementById('manualWineForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const payload = {
                name: document.getElementById('manualNameInput').value,
                vintage: parseInt(document.getElementById('manualVintageInput').value, 10),
                varietal: document.getElementById('manualVarietalInput').value,
                region: document.getElementById('manualRegionInput').value,
                quantity: parseInt(document.getElementById('manualQuantityInput').value, 10)
            };

            if (!payload.name || isNaN(payload.vintage) || isNaN(payload.quantity)) {
                showMessage('manualAddMessage', 'Please fill in all required fields.', 'error', true);
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}add-manual-wine`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Failed to add wine');
                
                showMessage('manualAddMessage', result.message || 'Wine added successfully!', 'info', true);
                fetchInventory();
                
                setTimeout(() => {
                    closeManualAddModal();
                    document.getElementById('manualWineForm').reset();
                    document.getElementById('manualAddMessage').style.display = 'none';
                }, 1500);

            } catch (error) {
                showMessage('manualAddMessage', `Error: ${error.message}`, 'error', true);
            }
        });


        // --- Consume, Set Quantity, Delete ---
        async function consumeWine(vivinoUrl) {
            if (!confirm('Consume one unit of this wine?')) return;
            try {
                const response = await fetch(`${BASE_URL}inventory/wine/consume`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vivino_url: vivinoUrl })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Failed to consume wine');
                showMessage('inventoryMessage', 'Wine consumed successfully!');
                fetchInventory();
            } catch (error) {
                showMessage('inventoryMessage', `Error: ${error.message}`, 'error');
            }
        }

        async function setWineQuantity(vivinoUrl, newQuantity) {
            newQuantity = parseInt(newQuantity, 10);
            if (isNaN(newQuantity) || newQuantity < 0) {
                showMessage('inventoryMessage', 'Quantity must be a non-negative number.', 'error');
                fetchInventory();
                return;
            }
            try {
                const response = await fetch(`${BASE_URL}inventory/wine/set_quantity`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vivino_url: vivinoUrl, quantity: newQuantity })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Failed to set quantity');
                showMessage('inventoryMessage', result.message || 'Quantity updated!');
                fetchInventory();
            } catch (error) {
                showMessage('inventoryMessage', `Error: ${error.message}`, 'error');
            }
        }

        async function deleteWine(vivinoUrl) {
            if (!confirm('Delete this wine from your inventory? This cannot be undone.')) return;
            try {
                const response = await fetch(`${BASE_URL}inventory/wine`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vivino_url: vivinoUrl })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Failed to delete wine');
                showMessage('inventoryMessage', result.message || 'Wine deleted!');
                fetchInventory();
            } catch (error) {
                showMessage('inventoryMessage', `Error: ${error.message}`, 'error');
            }
        }

        // --- Maintenance Buttons ---
        document.getElementById('reinitializeDbButton').addEventListener('click', async () => {
            if (!confirm('ARE YOU SURE? This will permanently delete ALL wine data!')) return;
            try {
                const response = await fetch(`${BASE_URL}reinitialize-database-action`, { method: 'POST' });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                showMessage('reinitializeDbMessage', data.message);
                fetchInventory();
            } catch (error) {
                showMessage('reinitializeDbMessage', `Error: ${error.message}`, 'error');
            }
        });

        document.getElementById('syncAllWinesButton').addEventListener('click', async () => {
            if (!confirm('Sync all wines to your Home Assistant To-Do list?')) return;
            try {
                const response = await fetch(`${BASE_URL}sync-all-wines`, { method: 'POST' });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                showMessage('syncMessage', data.message);
            } catch (error) {
                showMessage('syncMessage', `Error: ${error.message}`, 'error');
            }
        });

        // --- Vivino Search ---
        document.getElementById('vivinoSearchForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const query = document.getElementById('vivinoSearchInput').value;
            window.open(`https://www.vivino.com/search/wines?q=${encodeURIComponent(query)}`, '_blank');
            this.reset();
        });

        // --- Modal Functionality ---
        const helpModal = document.getElementById('helpModal');
        const manualAddModal = document.getElementById('manualAddModal');
        
        document.getElementById('helpButton').addEventListener('click', () => helpModal.classList.remove('hidden'));
        document.getElementById('openManualAddModalBtn').addEventListener('click', () => manualAddModal.classList.remove('hidden'));

        function closeHelpModal() {
            helpModal.classList.add('hidden');
        }
        function closeManualAddModal() {
            manualAddModal.classList.add('hidden');
        }

        // --- Sort Controls ---
        const sortSelect = document.getElementById('sortSelect');
        const sortDirectionToggle = document.getElementById('sortDirectionToggle');
        const sortAscIcon = document.getElementById('sortAscIcon');
        const sortDescIcon = document.getElementById('sortDescIcon');

        function updateSortIcons() {
            sortAscIcon.classList.toggle('hidden', currentSortDirection === 'desc');
            sortDescIcon.classList.toggle('hidden', currentSortDirection === 'asc');
        }

        sortSelect.addEventListener('change', (event) => {
            currentSortBy = event.target.value;
            applySortAndDisplayInventory();
        });

        sortDirectionToggle.addEventListener('click', () => {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            updateSortIcons();
            applySortAndDisplayInventory();
        });

        // --- Theme Toggling Logic ---
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');

        function enableDarkMode() {
            document.body.classList.add('dark-theme');
            localStorage.setItem('theme', 'dark');
            themeIcon.textContent = '🌙';
            themeText.textContent = 'Dark Mode';
        }

        function enableLightMode() {
            document.body.classList.remove('dark-theme');
            localStorage.setItem('theme', 'light');
            themeIcon.textContent = '☀️';
            themeText.textContent = 'Light Mode';
        }
        
        themeToggle.addEventListener('click', () => {
             if (document.body.classList.contains('dark-theme')) {
                enableLightMode();
            } else {
                enableDarkMode();
            }
        });
        
        // --- Page Load ---
        document.addEventListener('DOMContentLoaded', () => {
            updateSortIcons();
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                enableDarkMode();
            } else {
                enableLightMode();
            }
            fetchInventory();
        });
    </script>

</body>
</html>